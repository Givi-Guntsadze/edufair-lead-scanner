<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EduFair Live Scanner</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        :root {
            --primary: #3b82f6;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f1f5f9;
            --muted: #94a3b8;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Status Bar */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--card);
            border-bottom: 1px solid #334155;
        }

        .uni-name {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .network-status {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 99px;
            font-weight: 600;
        }

        .network-status.online {
            background: #166534;
            color: #bbf7d0;
        }

        .network-status.offline {
            background: #991b1b;
            color: #fecaca;
        }

        /* Scanner Area */
        #reader-container {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            background: #000;
        }

        #reader {
            width: 100%;
            max-width: 400px;
            border-radius: 12px;
            overflow: hidden;
        }

        /* Sync Bar */
        .sync-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--card);
            border-top: 1px solid #334155;
        }

        .pending-count {
            color: var(--muted);
            font-size: 0.9rem;
        }

        .pending-count.has-pending {
            color: var(--warning);
            font-weight: 600;
        }

        .sync-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        .sync-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Recent Scans List */
        .scans-list-container {
            max-height: 200px;
            overflow-y: auto;
            background: var(--card);
        }

        .scans-list {
            list-style: none;
        }

        .scan-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid #334155;
        }

        .scan-icon {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .scan-icon.pending {
            background: var(--warning);
        }

        .scan-icon.synced {
            background: var(--success);
        }

        .scan-info {
            flex-grow: 1;
        }

        .scan-uuid {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .scan-time {
            font-size: 0.75rem;
            color: var(--muted);
        }

        .empty-state {
            padding: 24px;
            text-align: center;
            color: var(--muted);
            font-size: 0.9rem;
        }

        /* Flash Overlay */
        .flash-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--success);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease-out;
            z-index: 100;
        }

        .flash-overlay.show {
            opacity: 1;
        }

        .flash-text {
            font-size: 2rem;
            font-weight: 700;
            color: white;
        }
    </style>
</head>

<body>

    <!-- Flash Overlay for scan feedback -->
    <div id="flash-overlay" class="flash-overlay">
        <span class="flash-text">âœ“ Saved!</span>
    </div>

    <!-- Top Status Bar -->
    <div class="status-bar">
        <span id="uni-name" class="uni-name">Loading...</span>
        <span id="network-status" class="network-status online">ONLINE</span>
    </div>

    <!-- Camera/Scanner -->
    <div id="reader-container">
        <div id="reader"></div>
    </div>

    <!-- Sync Bar -->
    <div class="sync-bar">
        <span id="pending-count" class="pending-count">All synced</span>
        <button id="sync-btn" class="sync-btn" disabled>Sync Now</button>
    </div>

    <!-- Recent Scans List -->
    <div class="scans-list-container">
        <ul id="scans-list" class="scans-list">
            <li class="empty-state">No scans yet. Point camera at a QR code.</li>
        </ul>
    </div>

    <script>
        // =====================================================
        // CONFIGURATION - Paste your Google Apps Script URL here
        // =====================================================
        const API_URL = "https://script.google.com/macros/s/AKfycbyTzTjpUhAXTr5qevH8nnvwdzqLevxMWz8RxBt0ZXTVAsm3iy4J78JodPvm8-dE7yM7yA/exec";
        // =====================================================

        // --- STATE ---
        const STORAGE_KEY = 'edufair_scan_queue';
        let scanQueue = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        let isOnline = navigator.onLine;
        let isSyncing = false;
        let html5QrCode = null;

        // --- Get University ID from URL ---
        const urlParams = new URLSearchParams(window.location.search);
        const UNI_ID = urlParams.get('uni');

        if (!UNI_ID) {
            document.body.innerHTML = `
        <div style="padding: 40px; text-align: center;">
            <h1 style="color: #ef4444;">Configuration Error</h1>
            <p style="color: #94a3b8; margin-top: 16px;">
                Missing <code>?uni=NAME</code> in URL.<br><br>
                Example: <code>yoursite.com/scan?uni=HARVARD</code>
            </p>
        </div>
    `;
            throw new Error("Missing uni parameter");
        }

        document.getElementById('uni-name').textContent = UNI_ID;

        // --- NETWORK STATUS ---
        function updateNetworkStatus() {
            const el = document.getElementById('network-status');
            if (isOnline) {
                el.textContent = 'ONLINE';
                el.className = 'network-status online';
            } else {
                el.textContent = 'OFFLINE';
                el.className = 'network-status offline';
            }
        }

        window.addEventListener('online', () => { isOnline = true; updateNetworkStatus(); sync(); });
        window.addEventListener('offline', () => { isOnline = false; updateNetworkStatus(); });

        // --- QUEUE MANAGEMENT ---
        function saveQueue() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(scanQueue));
        }

        function addToQueue(uuid) {
            // Prevent duplicate UUIDs (same person scanned twice in quick succession)
            if (scanQueue.some(s => s.uuid === uuid)) {
                console.log('Duplicate scan ignored:', uuid);
                return null;
            }

            const scanData = {
                id: Date.now(),
                uni: UNI_ID,
                uuid: uuid,
                timestamp: new Date().toISOString(),
                status: 'pending' // pending | synced
            };

            scanQueue.push(scanData);
            saveQueue();
            return scanData;
        }

        function markSynced(id) {
            const scan = scanQueue.find(s => s.id === id);
            if (scan) {
                scan.status = 'synced';
                saveQueue();
            }
        }

        function getPendingCount() {
            return scanQueue.filter(s => s.status === 'pending').length;
        }

        // --- SYNC LOGIC ---
        async function sync() {
            if (isSyncing || !isOnline) return;

            const pending = scanQueue.filter(s => s.status === 'pending');
            if (pending.length === 0) return;

            isSyncing = true;
            updateUI();

            for (const scan of pending) {
                try {
                    // Use GET with URL parameters - more reliable with Google Apps Script
                    const params = new URLSearchParams({
                        uni: scan.uni,
                        uuid: scan.uuid,
                        timestamp: scan.timestamp
                    });

                    const response = await fetch(`${API_URL}?${params.toString()}`, {
                        method: 'GET',
                        redirect: 'follow'
                    });

                    // Check if we got a valid response
                    if (response.ok) {
                        const result = await response.json();
                        if (result.result === 'success') {
                            markSynced(scan.id);
                            updateScanItemUI(scan.id, 'synced');
                        } else {
                            console.error('Sync error:', result.message);
                        }
                    }
                } catch (error) {
                    console.error('Sync failed for', scan.uuid, error);
                    // Stop trying on network error
                    break;
                }
            }

            isSyncing = false;
            updateUI();
        }

        // Auto-retry sync every 5 seconds
        setInterval(() => {
            if (isOnline && getPendingCount() > 0) {
                sync();
            }
        }, 5000);

        // Manual sync button
        document.getElementById('sync-btn').addEventListener('click', sync);

        // --- UI UPDATES ---
        function updateUI() {
            const count = getPendingCount();
            const countEl = document.getElementById('pending-count');
            const btnEl = document.getElementById('sync-btn');

            if (count > 0) {
                countEl.textContent = `${count} pending upload${count > 1 ? 's' : ''}`;
                countEl.className = 'pending-count has-pending';
                btnEl.disabled = isSyncing;
                btnEl.textContent = isSyncing ? 'Syncing...' : 'Sync Now';
            } else {
                countEl.textContent = 'All synced';
                countEl.className = 'pending-count';
                btnEl.disabled = true;
                btnEl.textContent = 'Sync Now';
            }
        }

        function addScanToListUI(scanData) {
            const list = document.getElementById('scans-list');

            // Remove empty state if present
            const emptyState = list.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            const li = document.createElement('li');
            li.className = 'scan-item';
            li.id = `scan-${scanData.id}`;
            li.innerHTML = `
        <span class="scan-icon ${scanData.status}"></span>
        <div class="scan-info">
            <div class="scan-uuid">${scanData.uuid}</div>
            <div class="scan-time">${new Date(scanData.timestamp).toLocaleTimeString()}</div>
        </div>
    `;
            list.prepend(li);
        }

        function updateScanItemUI(id, status) {
            const item = document.getElementById(`scan-${id}`);
            if (item) {
                const icon = item.querySelector('.scan-icon');
                icon.className = `scan-icon ${status}`;
            }
        }

        function showFlash() {
            const overlay = document.getElementById('flash-overlay');
            overlay.classList.add('show');
            setTimeout(() => overlay.classList.remove('show'), 300);
        }

        // --- SCANNER ---
        function onScanSuccess(decodedText) {
            // Add to queue
            const scanData = addToQueue(decodedText);

            if (scanData) {
                // Visual feedback
                showFlash();
                addScanToListUI(scanData);
                updateUI();

                // Try to sync immediately
                sync();
            }
        }

        function onScanFailure(error) {
            // Ignore scan failures (normal when no QR in view)
        }

        // --- INIT ---
        function init() {
            updateNetworkStatus();
            updateUI();

            // Render existing scans from queue (newest first)
            [...scanQueue].reverse().forEach(scan => addScanToListUI(scan));

            // Start scanner
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess,
                onScanFailure
            ).catch(err => {
                console.error("Camera error:", err);
                document.getElementById('reader').innerHTML = `
            <div style="padding: 40px; text-align: center; color: #ef4444;">
                Camera access denied or unavailable.<br>
                Please allow camera permissions.
            </div>
        `;
            });
        }

        init();
    </script>
</body>

</html>